import{j as e,r as a}from"./react-vendor--lxKGBiW.js";import{u as ge,a as p,g as f,t as T}from"./index-Bk3Do8do.js";import{B as x}from"./Button-DlSz7573.js";import{T as be,a as ye,b as ie,c as w,d as j}from"./Table-CBXGn4MI.js";import{s as re}from"./guide-D27LQTJO.js";import{S as H}from"./Skeleton-Bpnt4vlv.js";import{P as we}from"./Pager-CZom1-cd.js";import{U as z}from"./strings-ZJ386RGO.js";import{f as je}from"./sentry-ZUDTCraJ.js";import"./radix-Dc_FVRD7.js";import"./howler-DHXmObXC.js";import"./physics-DQSz9XbC.js";import"./analytics-BPch_qa6.js";import"./supabase-CZcX4Eou.js";import"./driver-D6Mpyj2M.js";function ve(i,o){try{const u=localStorage.getItem(i);return u?JSON.parse(u):o}catch{return o}}function Se(i,o){try{localStorage.setItem(i,JSON.stringify(o))}catch{}}function Ne({className:i="",...o}){const u=`border rounded-xl px-3 py-2 bg-white text-slate-900 focus:outline-none focus:ring-2 focus:ring-pink-200 shadow-sm ${i}`.trim();return e.jsx("input",{className:u,...o})}function ke({state:i,message:o,onRetry:u,className:C}){const R="inline-flex items-center gap-2 text-sm",g=i==="loading"?"text-slate-600":i==="success"?"text-green-700":i==="error"?"text-rose-700":"text-slate-600";return e.jsxs("div",{className:`${R} ${g} ${C||""}`.trim(),role:"status","aria-live":"polite",children:[i==="loading"&&e.jsxs("svg",{className:"animate-spin h-4 w-4",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"})]}),i==="success"&&e.jsx("svg",{className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-7.364 7.364a1 1 0 01-1.414 0L3.293 9.435a1 1 0 111.414-1.414l3.222 3.222 6.657-6.657a1 1 0 011.414 0z",clipRule:"evenodd"})}),i==="error"&&e.jsx("svg",{className:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v4a1 1 0 002 0V7zm0 6a1 1 0 11-2 0 1 1 0 012 0z",clipRule:"evenodd"})}),e.jsx("span",{children:o||(i==="loading"?"Working…":i==="success"?"Done":i==="error"?"Something went wrong":"")}),i==="error"&&u&&e.jsx("button",{onClick:u,className:"ml-2 text-rose-700 underline-offset-2 hover:underline",children:"Retry"})]})}function Pe(){const{showToast:i}=ge(),[o,u]=a.useState([]),[C]=a.useState(""),[R,g]=a.useState(""),[h,m]=a.useState(()=>ve("msg_draft",{contact_id:"",channel:"sms",subject:"",body:""})),[M,W]=a.useState(!0),[b,J]=a.useState({}),[K,le]=a.useState(void 0),[E,$]=a.useState(1),I=10,[v,oe]=a.useState([]),[D,ce]=a.useState(""),[l,q]=a.useState(null),[S,B]=a.useState([]),[G,F]=a.useState([]),[V,P]=a.useState(!1),[y]=a.useState(()=>{try{return localStorage.getItem("bvx_messages_filter")||"all"}catch{return"all"}}),[N,L]=a.useState(!1),[de,O]=a.useState(""),[U,Y]=a.useState("lead_followup"),[c,X]=a.useState(""),[Z,ue]=a.useState(null),[d,ee]=a.useState(null),te=t=>{try{if(!t)return"";const[s,n]=t.split(":").map(Number),r=s<12;return`${s%12||12}:${String(n||0).padStart(2,"0")} ${r?"AM":"PM"}`}catch{return String(t||"")}};a.useEffect(()=>{try{const t=new URLSearchParams(window.location.search),s=t.get("body"),n=t.get("cid");s&&m(r=>({...r,body:decodeURIComponent(s)})),n&&m(r=>({...r,contact_id:decodeURIComponent(n)}))}catch{}},[]);const se=[{label:"Reminder 24h",body:"Hey {FirstName} — see you tomorrow at {Time}. Need to change it? Tap here."},{label:"Waitlist open",body:"A spot opened for {Service} at {Time}. Want it? Reply YES and we’ll lock it in."},{label:"Lead follow‑up",body:"Hi! I saw you were looking at {Service}. I'd be happy to answer any questions or get you scheduled!"}],me=async()=>{const t=[C?`contact_id=${encodeURIComponent(C)}`:"",y?`filter=${encodeURIComponent(y)}`:""].filter(Boolean).join("&"),s=await p.get(`/messages/list?tenant_id=${encodeURIComponent(await f())}${t?"&"+t:""}`);u(s.items||[])};a.useEffect(()=>{(async()=>{try{W(!0),await me(),$(1)}finally{W(!1);try{window.__bvxMessagesReady=1,window.dispatchEvent(new CustomEvent("bvx:messages:ready"))}catch{}}})()},[y]),a.useEffect(()=>{(async()=>{try{const t=await p.get(`/settings?tenant_id=${encodeURIComponent(await f())}`);J(t?.data?.quiet_hours||{})}catch{}})()},[]),a.useEffect(()=>{(async()=>{try{const t=await p.get(`/contacts/list?tenant_id=${encodeURIComponent(await f())}&limit=500&offset=0`),n=(Array.isArray(t?.items)?t.items:[]).map(r=>({id:String(r.contact_id),name:String(r.friendly_name||r.display_name||`${r.first_name||""} ${r.last_name||""}`||"Client").trim()||"Client"}));oe(n)}catch{}})()},[]),a.useEffect(()=>{try{new URLSearchParams(window.location.search).get("tour")==="1"&&re("messages")}catch{}},[]),a.useEffect(()=>{(async()=>{try{const t=await p.post("/onboarding/analyze",{tenant_id:await f()});t?.summary?.ts&&le(Number(t.summary.ts))}catch{}})()},[]),a.useEffect(()=>{try{localStorage.setItem("bvx_messages_filter",y)}catch{}},[y]),a.useEffect(()=>{try{localStorage.setItem("bvx_messages_recipient",JSON.stringify(l||null))}catch{}},[l]),a.useEffect(()=>()=>{try{c&&URL.revokeObjectURL(c)}catch{}},[c]),a.useEffect(()=>{try{const t=sessionStorage.getItem("bvx_followups_bundle");if(t){const s=JSON.parse(t);sessionStorage.removeItem("bvx_followups_bundle"),ee(s)}}catch{}},[]),a.useEffect(()=>{if(!d||!Array.isArray(d.ids))return;const t=d.ids.map(n=>String(n));if(ue({bucket:String(d.bucket||"lead_followup"),ids:t,ts:Number(d.ts||Date.now())}),Y(String(d.bucket||"lead_followup")),d.markdown){m(n=>({...n,channel:"sms",body:String(d.markdown)}));try{c&&URL.revokeObjectURL(c)}catch{}try{const n=new Blob([String(d.markdown)],{type:"text/markdown;charset=utf-8;"}),r=URL.createObjectURL(n);X(r)}catch{}}if(!v.length)return;const s=v.filter(n=>t.includes(n.id));s.length&&(B(s),q(null)),ee(null)},[d,v,c]),a.useEffect(()=>{Se("msg_draft",h)},[h]),a.useEffect(()=>{const t=setTimeout(()=>{try{const s=D.trim().toLowerCase();if(!s){F([]);return}const n=v.filter(r=>r.name.toLowerCase().includes(s)).slice(0,8);F(n)}catch{F([])}},200);return()=>clearTimeout(t)},[D,v]);const ae=async()=>{try{const t=S.length>0?S:l?[l]:[];if(t.length===0){g("Pick at least one client."),i({title:"Choose clients",description:"Search and select one or more clients to draft for."});return}const s=je?.({name:"messages.draft"}),n=performance.now();try{T("messages.draft",{count:t.length,bucket:U,bulk:!0})}catch{}const r=await f(),ne=t.map(_=>_.name).join(", "),he=["Create a concise, friendly set of SMS drafts for beauty clients. Use beauty-friendly language and avoid jargon.",`Bucket: ${U}`,`Clients: ${ne}`,"Output as a Markdown document with one section per client:","- Heading as the client name","- 1–2 sentence SMS draft personalized for the client","- No code fences, no variables like {FirstName} — use the given name directly"].join(`
`),pe=await p.post("/ai/chat/raw",{tenant_id:r,messages:[{role:"user",content:he}],mode:"messages"},{timeoutMs:6e4});try{const _=Math.round(performance.now()-n);T("messages.draft",{ms:_,count:t.length}),s?.end?.()}catch{}const Q=String(pe?.text||"").trim();if(!Q){g("No draft returned");return}try{await navigator.clipboard.writeText(Q),i({title:"Copied",description:"Markdown copied to clipboard"})}catch{}try{c&&URL.revokeObjectURL(c)}catch{}try{const _=new Blob([Q],{type:"text/markdown;charset=utf-8;"}),fe=URL.createObjectURL(_);X(fe)}catch{}g("Bulk draft ready")}catch(t){g(String(t?.message||t))}},xe=t=>{const s=String(t?.status||"").toLowerCase();switch(y){case"unread":return s.includes("unread")||s.includes("new")||s.includes("received");case"needs_reply":return s.includes("await")||s.includes("no_reply")||s.includes("pending")||s.includes("needs");case"scheduled":return s.includes("scheduled")||s.includes("queued")||s.includes("delayed");case"failed":return s.includes("fail")||s.includes("error")||s.includes("bounce");default:return!0}},k=(o||[]).filter(xe),A=se.filter(t=>(t.label+t.body).toLowerCase().includes(de.toLowerCase()));return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"sticky top-0 z-20 bg-white/80 backdrop-blur border-b border-slate-200",children:e.jsxs("div",{className:"max-w-6xl mx-auto px-2 sm:px-3 py-2 flex items-center gap-3",children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Messages"}),e.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[e.jsx(ke,{state:M?"loading":"idle",message:M?"Loading messages…":""}),e.jsx(x,{variant:"outline",onClick:()=>re("messages"),"aria-label":z.a11y.buttons.guideMessages,children:z.ctas.tertiary.guideMe})]})]})}),M&&e.jsxs("div",{className:"space-y-3",children:[e.jsx(H,{className:"h-10"}),e.jsx(H,{className:"h-24"}),e.jsx(H,{className:"h-40"})]}),!M&&e.jsxs(e.Fragment,{children:[Z&&e.jsxs("div",{className:"rounded-md border bg-sky-50 text-sky-900 border-sky-200 text-xs px-2 py-1 inline-block",children:["Follow-ups loaded (",Z.ids.length,")"]}),K&&e.jsxs("div",{className:"text-[11px] text-slate-500",children:["Last analyzed: ",new Date(K*1e3).toLocaleString()]}),e.jsxs("div",{className:"rounded-2xl p-4 bg-white/60 backdrop-blur border border-white/70 shadow-sm","data-guide":"compose",children:[e.jsx("div",{className:"font-semibold mb-2",children:"Compose"}),e.jsx("div",{className:"text-[11px] text-slate-600 mb-1",children:"Pick one or more clients, choose a template, then Draft for me."}),e.jsxs("div",{className:"mb-2 text-xs flex items-center gap-2",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:["Template",e.jsxs("select",{className:"border rounded-md px-2 py-1 text-xs",value:U,onChange:t=>Y(t.target.value),children:[e.jsx("option",{value:"reminder_24h",children:"Reminder 24h"}),e.jsx("option",{value:"waitlist_open",children:"Waitlist open"}),e.jsx("option",{value:"lead_followup",children:"Lead follow‑up"}),e.jsx("option",{value:"reengage_30d",children:"Re‑engage 30d"}),e.jsx("option",{value:"winback_45d",children:"Win‑back 45d"}),e.jsx("option",{value:"no_show_followup",children:"No‑show follow‑up"}),e.jsx("option",{value:"first_time_nurture",children:"First‑time guest nurture"})]})]}),e.jsx(x,{variant:"outline",size:"sm",onClick:ae,children:"Draft for me"}),c&&e.jsx("a",{href:c,download:`followups_${U}_${new Date().toISOString().slice(0,10)}.md`,className:"px-3 py-1.5 rounded-md border bg-white text-xs",children:"Download Markdown"})]}),e.jsx("div",{className:"mb-2 text-xs text-sky-800 bg-sky-50 border border-sky-100 rounded-md px-2 py-1 inline-block",children:"Draft‑only for now — sending will enable after setup."}),!!b?.start&&!!b?.end&&e.jsxs("div",{className:"mb-2 text-xs text-slate-700 bg-slate-50 border border-slate-200 rounded-md px-2 py-1 inline-block","data-guide":"quiet",children:["Quiet hours: ",te(b.start),"–",te(b.end),". Sending will be disabled during this window."]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",role:"form","aria-label":"Send message form",children:[e.jsxs("div",{className:"relative",role:"combobox","aria-expanded":V,"aria-owns":"recipient-listbox","aria-haspopup":"listbox",children:[(S.length>0||l)&&e.jsx("div",{className:"mb-2 flex flex-wrap gap-2",children:[...S||[],...l?[l]:[]].map(t=>e.jsxs("span",{className:"inline-flex items-center gap-2 px-3 py-1 rounded-full border bg-white text-xs",children:[e.jsx("span",{className:"truncate max-w-[14rem]",children:t.name}),e.jsx("button",{className:"text-slate-500 hover:text-slate-700",onClick:()=>{B(s=>s.filter(n=>n.id!==t.id)),l&&l.id===t.id&&q(null),h.contact_id===t.id&&m(s=>({...s,contact_id:""}))},"aria-label":"Remove recipient",children:"×"})]},t.id))}),e.jsx(Ne,{placeholder:"Search client",value:l?"":D,onFocus:()=>P(!0),onBlur:()=>setTimeout(()=>P(!1),120),onChange:t=>{ce(t.target.value),q(null)},"aria-autocomplete":"list","aria-controls":"recipient-listbox","aria-label":"Search client"}),V&&G.length>0&&e.jsx("div",{id:"recipient-listbox",role:"listbox",className:"absolute z-10 mt-1 max-h-40 overflow-auto bg-white border rounded-md shadow-sm text-xs w-full",children:G.map(t=>{const s=S.some(n=>n.id===t.id)||l?.id===t.id;return e.jsx("button",{role:"option","aria-selected":!1,className:`block w-full text-left px-2 py-1 hover:bg-slate-50 ${s?"opacity-60":""}`,onMouseDown:n=>{n.preventDefault(),!s&&(B(r=>[...r,t]),m({...h,contact_id:t.id,channel:"sms"}),P(!1))},children:t.name||"Client"},t.id)})})]}),e.jsx("div",{className:"text-xs text-slate-600",children:"Channel: SMS"}),e.jsxs("div",{className:"sm:col-span-2 relative",children:[e.jsx("textarea",{className:"w-full min-h-[120px] border rounded-md px-3 py-2",placeholder:"Type your message or type / for templates",value:h.body,onChange:t=>m({...h,body:t.target.value}),onKeyDown:t=>{if(t.key==="/"){L(!0),O("");return}if(N&&t.key==="Escape"){L(!1);return}if(N&&t.key==="Backspace"){O(s=>s.slice(0,-1));return}if(N&&t.key==="Enter"){t.preventDefault();const s=A[0];s&&m(n=>({...n,body:s.body})),L(!1);return}if(N&&t.key.length===1&&!t.metaKey&&!t.ctrlKey&&!t.altKey){O(s=>s+t.key.toLowerCase());return}},"aria-label":"Message body"}),e.jsx("div",{className:"mt-2 flex gap-2",children:e.jsx(x,{variant:"outline",size:"sm",onClick:async()=>{try{await navigator.clipboard.writeText(h.body||""),i({title:"Copied",description:"Message copied to clipboard"})}catch{}},children:"Copy"})}),N&&e.jsxs("div",{role:"listbox",className:"absolute z-10 left-0 right-0 mt-1 max-h-40 overflow-auto bg-white border rounded-md shadow-sm text-xs",children:[A.length===0&&e.jsx("div",{className:"px-2 py-1 text-slate-500",children:"No matches"}),A.map(t=>e.jsxs("button",{role:"option",className:"block w-full text-left px-2 py-1 hover:bg-slate-50",onMouseDown:s=>{s.preventDefault(),m(n=>({...n,body:t.body})),L(!1)},children:[e.jsxs("span",{className:"font-medium mr-2",children:["/",t.label]}),e.jsx("span",{className:"text-slate-500 truncate inline-block max-w-[60%] align-middle",children:t.body})]},t.label))]})]})]}),e.jsxs("div",{className:"mt-2 text-xs text-slate-700 flex flex-wrap items-center gap-2",children:[e.jsx("span",{className:"font-medium",children:"Quiet hours:"}),e.jsx(x,{variant:"outline",size:"sm",onClick:()=>J({start:"21:00",end:"08:00"}),children:"Suggest 9:00 PM–8:00 AM"}),e.jsx(x,{variant:"outline",size:"sm",onClick:async()=>{try{await p.post("/settings",{tenant_id:await f(),quiet_hours:b}),T("integrations.guide.open",{area:"messages.save_quiet_hours"})}catch{}},"aria-label":z.a11y.buttons.saveQuietHours,children:z.ctas.secondary.save})]}),e.jsx("div",{className:"mt-2 text-[11px] font-medium text-slate-700",children:"Client Messaging Templates"}),e.jsx("div",{className:"mt-1 flex flex-wrap gap-2 text-xs","data-guide":"presets",children:se.map(t=>e.jsx(x,{variant:"outline",size:"sm",onClick:()=>m(s=>({...s,body:t.body})),children:t.label},t.label))}),R.includes("rate_limited")&&e.jsx("div",{className:"mt-2 text-xs text-amber-700 bg-amber-50 border border-amber-100 rounded-md px-2 py-1 inline-block",children:"Rate limited — please try again shortly."})]}),e.jsx("pre",{className:"whitespace-pre-wrap text-sm text-slate-700","data-guide":"status","aria-live":"polite",children:R}),k.length===0?null:e.jsxs(be,{"data-guide":"list",children:[e.jsx(ye,{children:e.jsxs(ie,{children:[e.jsx(w,{children:"ID"}),e.jsx(w,{children:"Contact"}),e.jsx(w,{children:"Channel"}),e.jsx(w,{children:"Status"}),e.jsx(w,{children:"Template"}),e.jsx(w,{children:"Time"})]})}),e.jsx("tbody",{className:"divide-y",children:k.slice((E-1)*I,E*I).map(t=>e.jsxs(ie,{children:[e.jsx(j,{children:t.id}),e.jsx(j,{children:e.jsx("span",{className:"truncate inline-block max-w-[10rem]",title:t.contact_id,children:t.contact_id})}),e.jsx(j,{children:t.channel}),e.jsx(j,{className:String(t.status).includes("rate")?"text-amber-700":"",children:e.jsx("span",{className:"truncate inline-block max-w-[10rem]",title:t.status,children:t.status})}),e.jsx(j,{children:e.jsx("span",{className:"truncate inline-block max-w-[12rem]",title:t.template_id||"",children:t.template_id||""})}),e.jsx(j,{children:e.jsx("span",{className:"truncate inline-block max-w-[12rem]",title:String(t.ts||""),children:t.ts})})]},t.id))})]}),k.length>0&&e.jsx(we,{page:E,pageSize:I,total:k.length,onPrev:()=>$(t=>Math.max(1,t-1)),onNext:()=>$(t=>t*I<k.length?t+1:t)})]})]}),e.jsx("div",{className:"fixed md:hidden left-0 right-0 bottom-[calc(env(safe-area-inset-bottom,0px))] z-30",children:e.jsxs("div",{className:"mx-3 mb-2 rounded-xl border bg-white/95 backdrop-blur shadow flex items-center justify-between px-2 py-2",children:[e.jsx(x,{variant:"outline",size:"sm",onClick:ae,"aria-label":"Draft for me",children:"Draft"}),e.jsx(x,{variant:"outline",size:"sm",onClick:async()=>{try{await p.post("/settings",{tenant_id:await f(),quiet_hours:b}),T("integrations.guide.open",{area:"messages.save_quiet_hours"})}catch{}},"aria-label":"Save quiet hours",children:"Save quiet"})]})})]})}export{Pe as default};
