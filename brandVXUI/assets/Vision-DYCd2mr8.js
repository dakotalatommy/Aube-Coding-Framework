import{r,j as a}from"./react-vendor--lxKGBiW.js";import{B as x}from"./Button-DlSz7573.js";import{g as b,a as E,t as F}from"./index-Bk3Do8do.js";import{s as Ne}from"./guide-D27LQTJO.js";import{f as de,c as me,g as Ee}from"./sentry-ZUDTCraJ.js";import"./radix-Dc_FVRD7.js";import"./howler-DHXmObXC.js";import"./physics-DQSz9XbC.js";import"./analytics-BPch_qa6.js";import"./supabase-CZcX4Eou.js";import"./driver-D6Mpyj2M.js";function We(){const ue=(()=>{try{return new URLSearchParams(window.location.search).get("onboard")==="1"}catch{return!1}})(),[u,C]=r.useState(""),[f,k]=r.useState(""),[S,I]=r.useState(""),[te,p]=r.useState(""),[y,L]=r.useState(!1),[P,$]=r.useState("image/jpeg"),[U,R]=r.useState(""),[ae]=r.useState([]),[O,pe]=r.useState(""),[T,H]=r.useState(!0),[se,he]=r.useState(null),[g,V]=r.useState(""),[ie,ne]=r.useState(50),[Ce,q]=r.useState(!1),ge=(()=>{try{return window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches}catch{return!1}})(),[fe,j]=r.useState(!1),[ke,W]=r.useState([]),[re]=r.useState(60),[Le,we]=r.useState(0),[Pe,ye]=r.useState(0),[Ue,G]=r.useState(0),[Re,J]=r.useState(0),[Te,X]=r.useState(""),[B,oe]=r.useState(""),[De,_]=r.useState(""),[Z,ve]=r.useState(""),[xe,K]=r.useState([]);r.useEffect(()=>{const e=setTimeout(async()=>{try{const t=Z.trim();if(t.length<2){K([]);return}const s=await b(),i=((await E.get(`/contacts/search?tenant_id=${encodeURIComponent(s)}&q=${encodeURIComponent(t)}&limit=8`))?.items||[]).map(o=>({contact_id:String(o.contact_id||""),display_name:String(o.display_name||"Client")}));K(i)}catch{K([])}},220);return()=>clearTimeout(e)},[Z]),r.useEffect(()=>{const e=t=>{const s=t.detail||{},n=String(s?.action||"");if(n==="vision.run-edit"){const i=String(s.prompt||"").trim();if(!i)return;R(i),y||A(i);return}if(n==="vision.prefill-prompt"){const i=String(s.prompt||"").trim();if(!i)return;R(i);try{Q.current?.focus()}catch{}}};return window.addEventListener("bvx:flow:vision-command",e),()=>window.removeEventListener("bvx:flow:vision-command",e)},[y]),r.useEffect(()=>{try{const e=JSON.parse(localStorage.getItem("bvx_vision_history")||"[]");Array.isArray(e)&&e.length&&W(e.slice(0,3))}catch{}},[]),r.useEffect(()=>{const e=s=>{try{if(s.target?.tagName==="TEXTAREA"||s.target?.tagName==="INPUT")return;(s.key==="u"||s.key==="U")&&(s.preventDefault(),ce()),(s.key==="e"||s.key==="E")&&(s.preventDefault(),A(U)),(s.key==="b"||s.key==="B")&&j(!0)}catch{}},t=s=>{try{(s.key==="b"||s.key==="B")&&j(!1)}catch{}};return window.addEventListener("keydown",e),window.addEventListener("keyup",t),()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",t)}},[U]),r.useEffect(()=>{(async()=>{try{const e=await b(),s=(await E.get(`/settings?tenant_id=${encodeURIComponent(e)}`))?.data?.vision||{};typeof s?.preserve_dims=="boolean"&&H(!!s.preserve_dims)}catch{}try{const e=localStorage.getItem("bvx_preserve_dims");e!=null&&H(e==="1")}catch{}})()},[]);const be=async(e=T)=>{try{const t=await b();await E.post("/settings",{tenant_id:t,vision:{preserve_dims:e}})}catch{}try{localStorage.setItem("bvx_preserve_dims",e?"1":"0")}catch{}},Q=r.useRef(null),D=r.useRef(null);r.useState(()=>{try{const e=new URLSearchParams(window.location.search),t=e.get("tour"),s=e.get("tourPage");t==="1"&&s==="vision"&&setTimeout(()=>Ne("vision"),200)}catch{}return 0}),r.useEffect(()=>{let e=!1;const t=()=>{if(!e){try{const s=document.querySelector('[data-guide="upload"]');if(s){const n=s.getBoundingClientRect?.();if(n&&n.width>0&&n.height>0){try{window.dispatchEvent(new CustomEvent("bvx:vision:ready"))}catch{}try{window.dispatchEvent(new CustomEvent("bvx:dbg",{detail:{type:"ready",pane:"vision"}}))}catch{}return}}}catch{}setTimeout(()=>{try{requestAnimationFrame(t)}catch{t()}},60)}};try{requestAnimationFrame(()=>{requestAnimationFrame(t)})}catch{setTimeout(t,60)}return()=>{e=!0}},[]);const ce=()=>Q.current?.click(),Y=e=>{if(!e)return;if(e.size>10*1024*1024){p("File too large (max 10MB).");return}try{const s=URL.createObjectURL(e);if(B)try{URL.revokeObjectURL(B)}catch{}oe(s),C(s);try{requestAnimationFrame(()=>{try{D.current?.setAttribute("data-vision-has-preview","1")}catch{}})}catch{}try{window.dispatchEvent(new CustomEvent("bvx:flow:vision-uploaded"))}catch{}ne(50);try{F("vision.upload",{size:e.size,type:e.type})}catch{}}catch{}const t=new FileReader;t.onload=async()=>{const s=String(t.result||"");try{const n=new Image;n.onload=async()=>{try{const i=n.width,o=n.height;we(i),ye(o),G(i),J(o),X(n.type||P||"");const d=12e6,c=i*o;let l=s;if(!T&&c>d){const m=Math.sqrt(d/c),w=Math.max(1,Math.floor(i*m)),M=Math.max(1,Math.floor(o*m)),N=document.createElement("canvas");N.width=w,N.height=M;const z=N.getContext("2d");if(z){z.drawImage(n,0,0,w,M);const v=e.type&&e.type.startsWith("image/")?e.type:"image/jpeg";l=N.toDataURL(v,.92)}}I("");const h=l.indexOf(",");k(h>=0?l.slice(h+1):l);try{const m=l.slice(5,l.indexOf(";"));m&&$(m)}catch{}}catch{}},n.src=s}catch{}try{const n=`I uploaded an image in brandVZN. Analyze it and, if appropriate, edit it. Current prompt: "${U||""}"`;let i=localStorage.getItem("bvx_chat_session")||"";i||(i="s_"+Math.random().toString(36).slice(2,10),localStorage.setItem("bvx_chat_session",i)),(async()=>{try{await E.post("/ai/chat/raw",{tenant_id:await b(),session_id:i,messages:[{role:"user",content:n}]})}catch{}})()}catch{}},t.readAsDataURL(e)},Se=e=>{const t=e.target.files?.[0];t&&Y(t)};r.useEffect(()=>{const e=D.current;if(!e)return;const t=n=>{try{n.preventDefault()}catch{}},s=n=>{try{n.preventDefault();const i=n.dataTransfer?.files?.[0];i&&Y(i)}catch{}};return e.addEventListener("dragover",t),e.addEventListener("drop",s),()=>{try{e.removeEventListener("dragover",t)}catch{}try{e.removeEventListener("drop",s)}catch{}}},[]),r.useEffect(()=>{const e=t=>{try{const s=t.clipboardData?.items||[];for(let n=0;n<s.length;n++){const i=s[n];if(i.kind==="file"){const o=i.getAsFile();if(o){Y(o);break}}}}catch{}};return window.addEventListener("paste",e),()=>window.removeEventListener("paste",e)},[]);const je=async()=>{if(!f&&!S)return;L(!0),p(""),_(""),q(!1);const e=window.setTimeout(()=>q(!0),2500);try{try{F("vision.analyze",{hasB64:!!f,mime:P})}catch{}const t=de?.({name:"vision.analyze.gpt5"}),s=await E.post("/ai/tools/execute",{tenant_id:await b(),name:"vision.analyze.gpt5",params:{tenant_id:await b(),...f?{inputImageBase64:f,inputMime:P}:{imageUrl:S},question:(O||"").trim()||void 0},require_approval:!1},{timeoutMs:6e4});try{t?.end?.()}catch{}try{window.clearTimeout(e)}catch{}const i=String(s?.brief||"");let o=0;const d=Math.max(2,Math.floor(i.length/200)),c=window.setInterval(()=>{o=Math.min(i.length,o+d),p(i.slice(0,o)),o>=i.length&&window.clearInterval(c)},20);try{F("integrations.reanalyze.click",{area:"brandvx.analyze.gpt5"})}catch{}}catch(t){try{me(t)}catch{}try{window.clearTimeout(e)}catch{}_(ee(t)),p(String(t?.message||t))}finally{L(!1)}},A=async e=>{if(!f&&!S){p("Upload or import an image first.");return}try{V(u)}catch{}L(!0),p(""),_("");try{q(!1);const t=window.setTimeout(()=>q(!0),2500),s=window.setTimeout(()=>{try{y&&(L(!1),_("timeout"),p("This edit is taking too long. Please retry, reduce size, or toggle Preserve Dimensions off."))}catch{}},45e3),n=de?.({name:"vision.run_edit"}),i=performance.now?performance.now():Date.now(),o=await E.post("/ai/tools/execute",{tenant_id:await b(),name:"image.edit",params:{tenant_id:await b(),mode:"edit",prompt:`${e}
Refinement intensity: ${re}/100.${O?`
Additional notes: ${O}`:""}`,...f?{inputImageBase64:f,inputMime:P}:{imageUrl:S},outputFormat:"png",preserveDims:T},require_approval:!1},{timeoutMs:9e4});if(o?.data_url||o?.preview_url){_("");const d=String(o?.data_url||o?.preview_url||"");if(d){try{g||V(u)}catch{}try{W(c=>[u,...c].slice(0,3))}catch{}C(d);try{if(d.startsWith("data:")){const c=d.indexOf(","),l=d.slice(0,c),h=d.slice(c+1),m=(()=>{try{return l.slice(5,l.indexOf(";"))||"image/png"}catch{return"image/png"}})();k(h),$(m),I("");try{const w=new Image;w.onload=()=>{G(w.width),J(w.height),X(m)},w.src=d}catch{}}else{const l=await(await fetch(d)).blob(),h=new FileReader,m=await new Promise((v,_e)=>{h.onerror=()=>_e(new Error("read failed")),h.onloadend=()=>v(String(h.result||"")),h.readAsDataURL(l)}),w=m.indexOf(","),M=m.slice(0,w),N=m.slice(w+1),z=(()=>{try{return M.slice(5,M.indexOf(";"))||l.type||"image/png"}catch{return l.type||"image/png"}})();C(m),k(N),$(z),I("");try{const v=new Image;v.onload=()=>{G(v.width),J(v.height),X(z)},v.src=m}catch{}}}catch{}}try{const c=D.current,l=Number(c?.getAttribute?.("data-vision-edits")||"0")||0;c?.setAttribute?.("data-vision-edits",String(l+1)),c?.setAttribute?.("data-vision-lastedit",String(Date.now()))}catch{}try{window.dispatchEvent(new CustomEvent("bvx:flow:vision-edit-complete",{detail:{prompt:e}}))}catch{}try{W(c=>(localStorage.setItem("bvx_vision_history",JSON.stringify(c)),c))}catch{}p("Edit complete.");try{he(Date.now())}catch{}try{const c=Math.round((performance.now?performance.now():Date.now())-i);if(F("vision.run_edit",{ms:c,preserveDims:T,mime:P||"",intensity:re}),c>8e3)try{Ee("vision.run_edit.slow",{level:"warning"})}catch{}}catch{}try{n?.end?.()}catch{}try{window.clearTimeout(t)}catch{}try{window.clearTimeout(s)}catch{}}else{const d=ee(o);try{const c=String(o?.detail||o?.message||o?.status||""),l=[c?`detail: ${c}`:"",o?.rid?`rid: ${String(o.rid)}`:"",o?.content_type?`type: ${String(o.content_type)}`:""].filter(Boolean).join(" | "),h=String(o?.body||""),m=h?`
${h.slice(0,400)}`:"";p(`${d}${l?`
(${l})`:""}${m}`)}catch{p(d)}_(d);try{window.dispatchEvent(new CustomEvent("bvx:flow:vision-edit-complete",{detail:{prompt:e,error:d}}))}catch{}try{if(String(o?.detail||o?.status||""||"").toLowerCase().includes("subscription_required")||d.toLowerCase().includes("subscription"))try{const l=new URL(window.location.href);l.searchParams.set("billing","prompt"),window.history.pushState({},"",l.toString()),window.dispatchEvent(new PopStateEvent("popstate"))}catch{}}catch{}}}catch(t){try{me(t)}catch{}const s=ee(t);try{const n=String(t?.detail||t?.status||t?.message||"");p(`${s}${n?`
(detail: ${n.slice(0,200)})`:""}`)}catch{p(String(s||t?.message||t))}_(s);try{if(String(t?.detail||t?.status||t?.message||""||"").toLowerCase().includes("subscription_required")||s.toLowerCase().includes("subscription")){const i=new URL(window.location.href);i.searchParams.set("billing","prompt"),window.history.pushState({},"",i.toString()),window.dispatchEvent(new PopStateEvent("popstate"))}}catch{}}finally{try{L(!1)}catch{}}},le=(!!f||!!S)&&!y;try{new URLSearchParams(window.location.search).get("onboard")==="1"&&(Number(D.current?.getAttribute?.("data-vision-edits")||"0")||0)>0&&localStorage.setItem("bvx_done_vision","1")}catch{}function ee(e){try{const t=String(e?.detail||e?.status||e?.message||e||"").toLowerCase();return t?t.includes("rate_limited")?"Too many requests. Please wait a few seconds and try again.":t.includes("invalid_image")||t.includes("missing_image")?"Please upload a JPG or PNG (≤10MB) and try again.":t.includes("gemini")&&t.includes("http_400")?"The image edit was not accepted. Try a shorter, clearer prompt (e.g., “Make eyes blue”).":t.includes("vertex_http_400")?"Cloud model rejected this request. Try simplifying the prompt or re‑uploading as JPG.":t.includes("no_image_returned")?"No image was returned. Try re‑running, or toggle Preserve Dimensions off and retry.":t.includes("http_5")?"The model is temporarily unavailable. Please retry in a moment.":t.includes("timeout")?"This took too long. Please retry. Large images can slow things down.":"Edit failed. Try a simpler prompt or re‑upload the image.":"Something went wrong."}catch{return"Edit failed. Please try again."}}return a.jsxs("div",{className:"space-y-4 overflow-y-auto pb-3 h-full",children:[a.jsx("div",{className:"sticky top-0 z-20 bg-white/80 backdrop-blur border-b border-slate-200",children:a.jsxs("div",{className:"max-w-6xl mx-auto px-2 sm:px-3 py-2 flex items-center justify-between gap-3",children:[a.jsx("div",{className:"flex items-center gap-3 text-sm text-slate-600",children:se&&a.jsxs("span",{className:"text-slate-500",children:["Last edited ",new Date(se).toLocaleTimeString()]})}),a.jsx("div",{className:"flex items-center gap-2"})]})}),a.jsxs("div",{className:"flex items-center",children:[a.jsx("h3",{className:"text-lg font-semibold",children:"brandVZN"}),a.jsx("div",{className:"ml-auto flex items-center gap-2",children:a.jsx(x,{variant:"outline",size:"sm",onClick:()=>{window.location.href="/ask"},children:"AskVX"})})]}),a.jsxs("div",{className:"flex flex-col gap-3 items-start pb-16 md:pb-0",children:[a.jsxs("div",{ref:D,className:"w-full h-[420px] md:h-[460px] border rounded-xl bg-white shadow-sm overflow-hidden relative select-none z-10","data-guide":"preview",onMouseDown:()=>j(!0),onMouseUp:()=>j(!1),onMouseLeave:()=>j(!1),onTouchStart:()=>j(!0),onTouchEnd:()=>j(!1),title:"Drop an image here or paste (Cmd/Ctrl+V)",children:[!u&&a.jsx("div",{className:"absolute inset-0 grid place-items-center text-slate-500 text-sm p-2 text-center",children:a.jsxs("div",{children:[a.jsx("div",{children:"Drop or paste an image to start"}),a.jsx("div",{className:"text-[11px] mt-1",children:"or click Upload below"})]})}),u&&a.jsxs(a.Fragment,{children:[g&&g!==u&&a.jsx("img",{src:g,alt:"before",className:"absolute inset-0 object-contain w-full h-full"}),a.jsx("img",{src:u,alt:"after",className:"absolute inset-0 object-contain w-full h-full",style:g&&g!==u?{clipPath:`inset(0 ${Math.max(0,100-ie)}% 0 0)`,transition:ge?void 0:"clip-path 120ms ease"}:void 0}),g&&g!==u&&a.jsx("div",{className:"absolute left-0 right-0 bottom-1 flex items-center justify-center px-2",children:a.jsx("input",{type:"range",min:0,max:100,value:ie,onChange:e=>ne(parseInt(e.target.value)),"aria-label":"Compare before/after",className:"w-full"})}),g&&a.jsx("div",{className:"absolute bottom-1 right-1 text-[10px] px-1.5 py-0.5 rounded bg-black/50 text-white",children:fe?"Before":"After"})]})]}),a.jsxs("div",{className:"flex-1 space-y-3",children:[a.jsxs("div",{className:"grid gap-3 items-start grid-cols-[minmax(0,1fr)_auto_minmax(0,1fr)]",children:[a.jsx("textarea",{className:"w-full border rounded-md px-3 py-2",rows:3,value:U,onChange:e=>R(e.target.value),placeholder:u?"Type an edit prompt (e.g., “Change hair color to copper”)":"Click here to start editing or upload a photo to begin"}),a.jsxs("div",{className:"shrink-0 flex flex-col gap-2",children:[a.jsx(x,{variant:"outline",onClick:ce,"data-guide":"upload","aria-label":"Upload image",children:"Upload"}),a.jsx("input",{ref:Q,type:"file",accept:".jpg,.jpeg,.png,.dng,image/*",className:"hidden",onChange:Se}),a.jsx(x,{variant:"outline",disabled:!f&&!S||y,onClick:je,"data-guide":"analyze","aria-label":"Analyze photo",children:y?"Analyzing…":"Analyze Photo"}),a.jsx(x,{variant:"outline",disabled:!f&&!S||y,onClick:()=>A(U),"data-guide":"edit","aria-label":"Run edit",children:y?"Editing…":"Run Edit"})]}),a.jsx("div",{className:"rounded-xl border bg-white p-3 text-sm min-h-[96px] min-w-[260px] md:min-w-[320px]","aria-live":"polite",children:te?a.jsx("div",{className:"whitespace-pre-wrap",children:te}):a.jsx("div",{className:"text-xs text-slate-500",children:"Run Analyze to see a brief here."})})]}),ue&&a.jsxs("div",{className:"mt-2 grid grid-cols-1 md:grid-cols-2 gap-2 text-xs",children:[a.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[a.jsx("span",{className:"text-slate-600",children:"Hair:"}),["copper","espresso brown","platinum blonde","rose gold","jet black"].map(e=>a.jsx(x,{variant:"outline",size:"sm",onClick:()=>{const t=`Change hair color to ${e}`;R(t),le&&A(t)},children:e},e))]}),a.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[a.jsx("span",{className:"text-slate-600",children:"Eyes:"}),["blue","green","hazel","amber","gray"].map(e=>a.jsx(x,{variant:"outline",size:"sm",onClick:()=>{const t=`Change eye color to ${e}`;R(t),le&&A(t)},children:e},e))]})]}),!1,a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-2 items-end",children:[a.jsxs("label",{className:"grid gap-1",children:[a.jsx("span",{className:"text-xs text-slate-600",children:"Client name"}),a.jsx("input",{list:"client-suggest",className:"border rounded-md px-3 py-2",value:Z,onChange:e=>{ve(e.target.value)},placeholder:"Jane Doe"}),a.jsx("datalist",{id:"client-suggest",children:xe.map(e=>a.jsx("option",{value:e.display_name},e.contact_id))})]}),a.jsxs("label",{className:"md:col-span-2 grid gap-1",children:[a.jsx("span",{className:"text-xs text-slate-600",children:"Notes (optional)"}),a.jsx("input",{className:"border rounded-md px-3 py-2",value:O,onChange:e=>pe(e.target.value),placeholder:"Lighting edit, version A…"})]})]}),a.jsx("div",{className:"flex flex-wrap items-center gap-3",children:a.jsxs("label",{className:"inline-flex items-center gap-2",title:"Keep output size the same as the original",children:[a.jsx("input",{type:"checkbox",checked:T,onChange:async e=>{const t=e.target.checked;H(t),await be(t)},"aria-label":"Preserve original dimensions"}),a.jsx("span",{className:"text-xs text-slate-600",children:"Preserve Original Dimensions"})]})}),!1,!1,a.jsx("div",{className:"mt-3 flex flex-wrap items-center gap-2"})]})]}),!1,u&&a.jsxs("div",{className:"mt-2",children:[a.jsx(x,{variant:"outline",size:"sm",onClick:async()=>{try{const e=document.createElement("a");if(e.href=u,e.download="edited.png",document.body.appendChild(e),e.click(),document.body.removeChild(e),g){const t=document.createElement("a");t.href=g,t.download="original.png",document.body.appendChild(t),t.click(),document.body.removeChild(t)}}catch{}},children:"Download original + edited"}),!1,!u&&a.jsx(x,{variant:"outline",size:"sm",className:"ml-2",onClick:async()=>{try{const e=document.createElement("canvas");e.width=512,e.height=512;const t=e.getContext("2d");if(!t)return;const s=t.createLinearGradient(0,0,512,512);s.addColorStop(0,"#fce7f3"),s.addColorStop(1,"#e0e7ff"),t.fillStyle=s,t.fillRect(0,0,512,512),t.fillStyle="#111827",t.font="bold 28px system-ui, sans-serif",t.fillText("brandVZN sample",130,260);const n=e.toDataURL("image/png"),i=n;if(B)try{URL.revokeObjectURL(B)}catch{}oe(i),C(i),V(i);const o=n.indexOf(",");k(o>=0?n.slice(o+1):n);try{$("image/png")}catch{}}catch{}},children:"Use sample image"})]}),ae.length>0&&a.jsx("div",{className:"mt-2 grid grid-cols-6 gap-2",children:ae.map((e,t)=>a.jsx("button",{className:"aspect-square overflow-hidden border rounded hover:ring-2 ring-pink-300",onClick:()=>{C(e),I(e),k("")},children:a.jsx("img",{src:e,alt:`ig_${t}`,className:"object-cover w-full h-full"})},t))})]})}export{We as default};
