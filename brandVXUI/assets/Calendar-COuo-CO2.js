import{r as l,j as t}from"./react-vendor--lxKGBiW.js";import{u as K,a as c,g as r}from"./index-Bk3Do8do.js";import{s as P}from"./guide-D27LQTJO.js";import{U as y}from"./strings-ZJ386RGO.js";import{S as w}from"./Skeleton-Bpnt4vlv.js";import{E as Z}from"./EmptyState-BVAWAqiR.js";import{P as ee}from"./Pager-CZom1-cd.js";import"./radix-Dc_FVRD7.js";import"./sentry-ZUDTCraJ.js";import"./howler-DHXmObXC.js";import"./physics-DQSz9XbC.js";import"./analytics-BPch_qa6.js";import"./supabase-CZcX4Eou.js";import"./driver-D6Mpyj2M.js";function xe(){const{toastSuccess:b,toastError:h,showToast:j}=K(),[m,p]=l.useState([]),[f,v]=l.useState({}),[E,$]=l.useState(!0),[A,I]=l.useState(""),[d,q]=l.useState("all"),[N,R]=l.useState(1),x=12,[M,O]=l.useState(void 0),[S,F]=l.useState({}),[G,z]=l.useState(!1),[T,g]=l.useState(0),[_,u]=l.useState(!1),B=(()=>{try{return new URLSearchParams(window.location.search).get("demo")==="1"}catch{return!1}})(),D=new Date,C=new Date(D.getFullYear(),D.getMonth(),1),X=C.getDay(),k=new Date(C);k.setDate(C.getDate()-X);const H=Array.from({length:42},(e,a)=>{const s=new Date(k);return s.setDate(k.getDate()+a),s}),J=(m||[]).reduce((e,a)=>{try{const s=a.start_ts,n=typeof s=="number"?s:Number(s),i=isFinite(n)&&n>0?new Date(n*(n<1e12?1e3:1)):null,o=i?new Date(i.getFullYear(),i.getMonth(),i.getDate()).toISOString().slice(0,10):"other";(e[o]=e[o]||[]).push(a)}catch{(e.other=e.other||[]).push(a)}return e},{}),U=e=>{try{const a=typeof e=="number"?e:Number(e);return new Date(a*(a<1e12?1e3:1)).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"})}catch{return String(e||"")}};l.useEffect(()=>{(async()=>{try{const e=await c.get(`/calendar/events?tenant_id=${encodeURIComponent(await r())}`);p(Array.isArray(e?.items)?e.items:[]),v({}),g(Date.now())}finally{$(!1)}})()},[]),l.useEffect(()=>{try{new URLSearchParams(window.location.search).get("tour")==="1"&&P("calendar")}catch{}},[]),l.useEffect(()=>{(async()=>{try{const e=new Date,a=e.getDay(),s=(a===0?-6:1)-a,n=new Date(e);n.setDate(e.getDate()+s),n.setHours(0,0,0,0);const i=new Date(n);i.setDate(n.getDate()+6),i.setHours(23,59,59,999),await c.post("/ai/tools/execute",{tenant_id:await r(),name:"calendar.sync",params:{tenant_id:await r(),range_start:Math.floor(n.getTime()/1e3),range_end:Math.floor(i.getTime()/1e3)},require_approval:!1});const o=await c.get(`/calendar/events?tenant_id=${encodeURIComponent(await r())}`);p(Array.isArray(o?.items)?o.items:[]),v({}),g(Date.now())}catch{}})()},[]),l.useEffect(()=>{(async()=>{try{const e=await c.post("/onboarding/analyze",{tenant_id:await r()});e?.summary?.ts&&O(Number(e.summary.ts)),e?.summary?.connected&&F(e.summary.connected)}catch{}})()},[]),l.useEffect(()=>{try{z(!1)}catch{}},[f,JSON.stringify(m)]);const Q=async e=>{const a=await c.post("/ai/tools/execute",{tenant_id:await r(),name:"calendar.sync",params:{tenant_id:await r(),provider:e},require_approval:!1});try{a?.status==="ok"||a?.status==="pending"?b("Calendar sync started",e?`Provider: ${e}`:void 0):h("Calendar sync failed",a?.error||a?.status)}catch{}I(new URLSearchParams(window.location.search).has("dev")?JSON.stringify(a):"");const s=await c.get(`/calendar/events?tenant_id=${encodeURIComponent(await r())}`);p(Array.isArray(s?.items)?s.items:[]),v({});try{j({title:"Sync started",description:e||"all"})}catch{}g(Date.now())},V=async()=>{try{const e=await c.get(`/oauth/google/login?tenant_id=${encodeURIComponent(await r())}&return=workspace`);if(e?.url)try{window.location.href=e.url}catch{window.location.assign(e.url)}}catch{}},L=async(e,a)=>{try{u(!0);const s=Number(e.start_ts||0)+a*60,n={tenant_id:await r(),start_ts:s};e.provider&&e.id?(n.provider=String(e.provider),n.provider_event_id=String(e.id)):e.external_ref&&(n.external_ref=String(e.external_ref));const i=await c.post("/ai/tools/execute",{tenant_id:await r(),name:"calendar.reschedule",params:n,require_approval:!0});if(i?.status==="ok"||i?.status==="pending")try{b("Rescheduled","Queued")}catch{}else try{h("Reschedule failed",String(i?.status||"error"))}catch{}const o=await c.get(`/calendar/events?tenant_id=${encodeURIComponent(await r())}`);p(Array.isArray(o?.items)?o.items:[]),g(Date.now())}catch(s){try{h("Reschedule failed",String(s?.message||s))}catch{}}finally{u(!1)}},W=async e=>{try{u(!0);const a={tenant_id:await r()};e.provider&&e.id?(a.provider=String(e.provider),a.provider_event_id=String(e.id)):e.external_ref&&(a.external_ref=String(e.external_ref));const s=await c.post("/ai/tools/execute",{tenant_id:await r(),name:"calendar.cancel",params:a,require_approval:!0});if(s?.status==="ok"||s?.status==="pending")try{b("Canceled","Queued")}catch{}else try{h("Cancel failed",String(s?.status||"error"))}catch{}const n=await c.get(`/calendar/events?tenant_id=${encodeURIComponent(await r())}`);p(Array.isArray(n?.items)?n.items:[]),g(Date.now())}catch(a){try{h("Cancel failed",String(a?.message||a))}catch{}}finally{u(!1)}};return E?t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx(w,{className:"h-6 w-32"}),t.jsx(w,{className:"h-5 w-20"})]}),t.jsx(w,{className:"h-8"}),t.jsx(w,{className:"h-40"}),t.jsx(w,{className:"h-8"})]}):t.jsxs("div",{className:"flex h-full flex-col overflow-hidden",children:[t.jsxs("div",{className:"space-y-3 shrink-0",children:[t.jsxs("div",{className:"flex items-center",children:[t.jsx("h3",{className:"text-lg font-semibold",children:"Calendar"}),t.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[t.jsx("button",{className:"text-sm text-slate-600 hover:underline","aria-label":y.a11y.buttons.guideCalendar,onClick:()=>P("calendar"),children:y.ctas.tertiary.guideMe}),t.jsx("button",{className:"px-2 py-1 rounded-md border bg-white text-xs",onClick:()=>{try{const e=new URL(window.location.href);e.pathname="/workspace",e.searchParams.set("pane","askvx"),window.history.pushState({},"",e.toString()),window.dispatchEvent(new CustomEvent("bvx:guide:navigate",{detail:{pane:"askvx"}}))}catch{window.location.href="/workspace?pane=askvx"}},children:"AskVX"})]})]}),(()=>{try{const e=Math.max(0,...Object.values(f||{}).map(a=>Number(a?.ts||0)));if(e>0&&Date.now()/1e3-e>900)return t.jsx("div",{className:"rounded-md border bg-amber-50 border-amber-200 text-amber-900 text-xs px-2 py-1",children:"Calendar may be out of date. Click Sync now to refresh."})}catch{}return null})(),t.jsx("div",{className:"text-[11px] text-slate-600",children:"Note: Scheduling from BrandVX is disabled. Calendar merges are read‑only."}),M&&t.jsxs("div",{className:"text-[11px] text-slate-500",children:["Last analyzed: ",new Date(M*1e3).toLocaleString()]}),!!T&&t.jsxs("div",{className:"text-[11px] text-slate-500",children:["Updated ",new Date(T).toLocaleTimeString()]}),t.jsxs("div",{className:"rounded-xl border bg-white/90 backdrop-blur p-3 shadow-sm",role:"region","aria-label":"Month view",children:[t.jsx("div",{className:"grid grid-cols-7 gap-2 text-xs text-slate-600 mb-2",children:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map(e=>t.jsx("div",{className:"text-center font-medium",children:e},e))}),t.jsx("div",{className:"grid grid-cols-7 gap-2",children:H.map((e,a)=>{const s=e.toISOString().slice(0,10),n=(J[s]||[]).filter(o=>d==="all"?!0:(o.provider||"")===d),i=e.getMonth()===D.getMonth();return t.jsxs("div",{className:`min-h-[120px] border rounded-md bg-white ${i?"":"opacity-60"}`,children:[t.jsx("div",{className:"sticky top-0 z-10 px-2 py-1 text-xs font-medium border-b bg-slate-50 flex items-center justify-between",children:t.jsx("span",{children:e.getDate()})}),t.jsxs("div",{className:"p-2 space-y-1 text-xs",children:[n.length===0?t.jsx("div",{className:"text-slate-400",children:"—"}):n.slice(0,3).map((o,Y)=>t.jsx("div",{className:"px-2 py-1 rounded border bg-white flex items-center justify-between gap-2",title:o.title,children:t.jsxs("div",{className:"truncate",children:[t.jsx("span",{className:"text-slate-500 mr-1",children:U(o.start_ts)}),o.title]})},Y)),n.length>3&&t.jsxs("div",{className:"text-[11px] text-slate-500",children:["+",n.length-3," more"]})]})]},a)})})]}),B&&t.jsxs("div",{className:"rounded-xl border bg-white p-3","aria-label":"7-day recommendations","data-guide":"list",children:[t.jsx("div",{className:"text-sm font-medium text-slate-800 mb-2",children:"Recommendations (demo)"}),t.jsx("div",{className:"text-xs text-slate-600 mb-2",children:"A 7‑day plan to get momentum quickly."}),t.jsxs("ul",{className:"list-disc ml-5 text-sm text-slate-700",children:[t.jsx("li",{children:"Day 1: Send 5 warm‑lead follow‑ups"}),t.jsx("li",{children:"Day 2: Confirm Friday appointments"}),t.jsx("li",{children:"Day 3: Post 1 service tip on Instagram"}),t.jsx("li",{children:"Day 4: Text no‑shows a friendly rebook link"}),t.jsx("li",{children:"Day 5: Share before/after from this week"}),t.jsx("li",{children:"Day 6: Message 2 dormant clients"}),t.jsx("li",{children:"Day 7: Review next week’s openings"})]})]}),t.jsxs("div",{className:"flex items-center gap-2 text-sm","data-guide":"filters",children:[t.jsx("span",{className:"text-slate-600",children:"Filter:"}),t.jsxs("select",{className:"border rounded-md px-2 py-1 bg-white",value:d,onChange:e=>q(e.target.value),children:[t.jsx("option",{value:"all",children:"All"}),t.jsx("option",{value:"google",children:"Google"}),G&&t.jsx("option",{value:"apple",children:"Apple"}),t.jsx("option",{value:"square",children:"Square"}),t.jsx("option",{value:"acuity",children:"Acuity"})]}),String(S.google||"")==="connected"&&t.jsx("button",{className:"px-3 py-1.5 rounded-md border bg-white hover:shadow-sm",onClick:async()=>{try{u(!0);const e=await c.post("/ai/tools/execute",{tenant_id:await r(),name:"calendar.push.google",params:{tenant_id:await r()},require_approval:!0});j({title:"Push started",description:`${Number(e?.pushed||0)} events mirrored`})}catch(e){j({title:"Push failed",description:String(e?.message||e)})}finally{u(!1)}},children:"Push to Google"})]})]}),t.jsx("div",{className:"mt-3 flex-1 overflow-hidden",children:t.jsxs("div",{className:"h-full overflow-y-auto rounded-xl border bg-white p-3 shadow-sm","data-guide":"list",children:[m.length===0?t.jsx(Z,{title:y.emptyStates.calendar.title,description:y.emptyStates.calendar.body,children:t.jsx("button",{className:"px-3 py-2 rounded-md border bg-white hover:shadow-sm",onClick:()=>{String(S.google||"")==="connected"?Q("google"):V()},children:String(S.google||"")==="connected"?y.ctas.secondary.syncNowGoogle:"Connect Google Calendar"})}):t.jsx("div",{className:"hidden md:grid grid-cols-7 gap-2",children:[]}),t.jsxs("div",{className:"md:hidden",children:[(m||[]).filter(e=>d==="all"?!0:(e.provider||"")===d).slice((N-1)*x,N*x).map((e,a)=>{const s=e.start_ts,n=typeof s=="number"?s:Number(s),i=isFinite(n)&&n>0?new Date(n*(n<1e12?1e3:1)).toLocaleString():String(s||"");return t.jsxs("div",{className:"px-2 py-1 rounded border bg-white flex items-center justify-between gap-2 mb-2",title:`${e.title} — ${i}`,children:[t.jsxs("div",{className:"truncate",children:[t.jsx("span",{className:"text-slate-500 mr-1",children:U(e.start_ts)}),e.title]}),t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("button",{disabled:_,className:"px-1.5 py-0.5 rounded-md border bg-white disabled:opacity-50 text-[11px]",onClick:()=>L(e,15),children:"+15"}),t.jsx("button",{disabled:_,className:"px-1.5 py-0.5 rounded-md border bg-white disabled:opacity-50 text-[11px]",onClick:()=>L(e,-15),children:"-15"}),t.jsx("button",{disabled:_,className:"px-1.5 py-0.5 rounded-md border bg-white disabled:opacity-50 text-[11px]",onClick:()=>W(e),children:"X"})]})]},a)}),(m||[]).filter(e=>d==="all"?!0:(e.provider||"")===d).length>x&&t.jsx(ee,{page:N,pageSize:x,total:m.filter(e=>d==="all"?!0:(e.provider||"")===d).length,onPrev:()=>R(e=>Math.max(1,e-1)),onNext:()=>R(e=>e*x<m.filter(a=>d==="all"?!0:(a.provider||"")===d).length?e+1:e)})]}),Object.keys(f||{}).length>0&&t.jsx("div",{className:"mt-3 flex flex-wrap gap-2 text-xs text-slate-700",children:Object.entries(f).map(([e,a])=>{const s=a?.ts?new Date((a?.ts||0)*1e3).toLocaleTimeString():"";return t.jsxs("span",{className:"px-2 py-1 rounded-md border bg-white",children:[e,": ",a?.status," ",s&&`· ${s}`]},e)})}),A&&t.jsx("pre",{"aria-live":"polite",className:"mt-2 text-xs text-slate-700 whitespace-pre-wrap",children:A})]})})]})}export{xe as default};
