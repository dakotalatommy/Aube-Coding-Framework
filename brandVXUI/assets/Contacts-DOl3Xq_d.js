import{u as mt,r as l,j as t}from"./react-vendor--lxKGBiW.js";import{u as pt,a as p,g as d,s as ut,A as ht,t as xt}from"./index-Bk3Do8do.js";import{B as w}from"./Button-DlSz7573.js";import{S as ft}from"./Skeleton-Bpnt4vlv.js";import{E as yt}from"./EmptyState-BVAWAqiR.js";import{P as gt}from"./Pager-CZom1-cd.js";import{s as O}from"./guide-D27LQTJO.js";import{U as K}from"./strings-ZJ386RGO.js";import"./radix-Dc_FVRD7.js";import"./sentry-ZUDTCraJ.js";import"./howler-DHXmObXC.js";import"./physics-DQSz9XbC.js";import"./analytics-BPch_qa6.js";import"./supabase-CZcX4Eou.js";import"./driver-D6Mpyj2M.js";function wt(y,o){try{return new URLSearchParams(typeof o=="string"?o:typeof window<"u"?window.location.search:"").get(y)}catch{return null}}function vt(y,o){try{const u=typeof window<"u"?new URLSearchParams(window.location.search):new URLSearchParams;Object.entries(y).forEach(([h,_])=>{_==null||_===""?u.delete(h):u.set(h,String(_))});const j=`${o?.pathname||(typeof window<"u"?window.location.pathname:"/")}?${u.toString()}`;o?.replace?window.history.replaceState({},"",j):window.history.pushState({},"",j)}catch{}}function bt(y,o,u=!0){vt({[y]:o??""},{replace:u})}function _t(y,o,u){try{const k=wt(y,u),j=parseInt(String(k||""),10);return Number.isFinite(j)&&j>0?j:o}catch{return o}}function At(){const y=mt(),{showToast:o}=pt(),u=(()=>{try{return new URLSearchParams(window.location.search).get("demo")==="1"}catch{return!1}})(),k=(()=>{try{return new URLSearchParams(window.location.search).get("onboard")==="1"}catch{return!1}})(),[j,h]=l.useState(""),[_,V]=l.useState(null),[I,G]=l.useState(!1),[m,X]=l.useState(null),[$,H]=l.useState(!1),[q,Q]=l.useState([]),[J,Y]=l.useState(0),[tt,C]=l.useState(!1),[z,W]=l.useState([]),[E,A]=l.useState(()=>_t("page",1)),R=10,[B,D]=l.useState({open:!1}),F=e=>{try{const s=(e.friendly_name||"").toString().trim();if(s&&!/^sq[:_]/i.test(s))return s;const n=(e.first_name||"").toString().trim(),r=(e.last_name||"").toString().trim(),x=`${n} ${r}`.trim();if(x)return x;const v=(e.display_name||"").toString().trim(),f=/^sq[:_]/i.test(v)||/^sq[^\s]{6,}$/i.test(v)||/^sq[:_]/i.test(e.contact_id||"");return v&&!f?v:"Client"}catch{return"Client"}};l.useEffect(()=>{try{new URLSearchParams(window.location.search).get("tour")==="1"&&O("contacts")}catch{}},[]);const T=async()=>{if(u){Q([]);return}try{C(!0);const e=await p.get(`/contacts/list?tenant_id=${encodeURIComponent(await d())}&limit=${encodeURIComponent(String(R))}&offset=${encodeURIComponent(String((E-1)*R))}`,{timeoutMs:2e4});Q(Array.isArray(e?.items)?e.items:[]),Y(Number(e?.total||0))}catch(e){try{o({title:"Load failed",description:String(e?.message||e)})}catch{}}finally{C(!1)}};l.useEffect(()=>{T()},[u,E]),l.useEffect(()=>{let e=!1;const s=()=>{if(!e){try{const n=document.querySelector('[data-guide="clients-import-status"]')||document.querySelector('[data-guide="clients-list"]');if(n){try{const r=document.querySelector("main .overflow-y-auto");n.scrollIntoView?.({block:"center"}),r?.scrollBy?.(0,1),r?.scrollBy?.(0,-1)}catch{}try{window.dispatchEvent(new CustomEvent("bvx:contacts:ready"))}catch{}try{window.dispatchEvent(new CustomEvent("bvx:dbg",{detail:{type:"ready",pane:"contacts"}}))}catch{}try{sessionStorage.getItem("bvx_auto_import")==="1"&&(sessionStorage.removeItem("bvx_auto_import"),setTimeout(()=>{try{M()}catch{}},0))}catch{}return}}catch{}setTimeout(()=>{try{requestAnimationFrame(s)}catch{s()}},60)}};try{requestAnimationFrame(()=>{requestAnimationFrame(s)})}catch{setTimeout(s,60)}return()=>{e=!0}},[y.search]),l.useEffect(()=>{try{bt("page",String(E),!0)}catch{}},[E]),l.useEffect(()=>{try{const e=new URLSearchParams(y.search),s=parseInt(e.get("page")||"1",10);Number.isFinite(s)&&s>0&&s!==E&&A(s)}catch{}},[y.search]);const Z=e=>{try{const s=Number(e||0);return s?new Date(s<1e12?s*1e3:s).toLocaleDateString():"-"}catch{return"-"}},et=e=>{try{return`$${(Number(e||0)/100).toFixed(2)}`}catch{return"$0.00"}},M=async()=>{if(u){h("Demo: import disabled.");return}try{G(!0),X(null);try{xt("contacts.import_booking")}catch{}try{window.dispatchEvent(new CustomEvent("bvx:flow:contacts-import-started"))}catch{}const s=(await p.post("/onboarding/analyze",{tenant_id:await d()}))?.summary?.connected||{},n=String(s.square||"").toLowerCase(),r=String(s.acuity||"").toLowerCase(),f=n==="connected"||n==="pending_config"?"square":r==="connected"||r==="pending_config"?"acuity":"auto";let b=0,g=0,i=0,P="";try{if(f==="square"){const c=await p.post("/ai/tools/execute",{tenant_id:await d(),name:"contacts.import.square",params:{tenant_id:await d()},require_approval:!1,idempotency_key:`square_import_${Date.now()}`});b=Number(c?.imported||0),g=Number(c?.updated||0),i=Number(c?.skipped||0),P=String(c?.top_reason||"");try{await p.post("/integrations/booking/square/backfill-metrics",{tenant_id:await d()})}catch{}}else if(f==="acuity"){const c=await p.post("/integrations/booking/acuity/import",{tenant_id:await d(),since:"0",until:"",cursor:""});b=Number(c?.imported||0),g=Number(c?.updated||0)}else await p.post("/calendar/sync",{tenant_id:await d(),provider:"auto"});X({provider:f,imported:b,updated:g,skipped:i,reasonTop:P});try{o({title:"Import complete",description:`${b} contacts imported`})}catch{}k&&V({status:"success",message:`${b} contacts imported • ${g} updated`});try{await p.post("/onboarding/complete_step",{tenant_id:await d(),step_key:"contacts_imported",context:{provider:f,imported:b,updated:g,skipped:i}})}catch{}try{k&&localStorage.setItem("bvx_done_contacts","1")}catch{}try{await T()}catch{}try{window.dispatchEvent(new CustomEvent("bvx:flow:contacts-imported",{detail:{provider:f,imported:b,updated:g,skipped:i}}))}catch{}try{const c=document.createElement("div");c.className="fixed z-[100] bottom-20 left-1/2 -translate-x-1/2 rounded-full border bg-white shadow px-3 py-2 text-xs text-slate-800",c.textContent="Next: Train VX with top client feedback or draft a dormant re‑engage.",document.body.appendChild(c),setTimeout(()=>{try{document.body.removeChild(c)}catch{}},5e3)}catch{}}catch(c){const N=String(c?.message||c);h(N);try{window.dispatchEvent(new CustomEvent("bvx:flow:contacts-imported",{detail:{error:N}}))}catch{}k&&V({status:"error",message:N});try{window.dispatchEvent(new CustomEvent("bvx:onboarding:skip-import"))}catch{}}}finally{G(!1)}};return l.useEffect(()=>{const e=s=>{(s.detail||{})?.action==="contacts.import"&&!I&&!$&&M()};return window.addEventListener("bvx:flow:contacts-command",e),()=>window.removeEventListener("bvx:flow:contacts-command",e)},[I,$]),t.jsxs("div",{className:"space-y-2",children:[t.jsxs("div",{className:"flex items-center px-1 py-0.5",children:[t.jsx("h3",{className:"text-lg font-semibold",children:"Clients"}),t.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[t.jsx(w,{variant:"outline",size:"sm",onClick:()=>O("contacts"),children:K.ctas.tertiary.guideMe}),t.jsx(w,{variant:"outline",size:"sm",onClick:()=>{window.location.href="/ask"},children:"AskVX"})]})]}),_&&t.jsxs("div",{"data-guide":"clients-import-status",className:`rounded-xl border px-3 py-2 text-xs shadow-sm flex items-center gap-2 ${_.status==="success"?"bg-emerald-50 border-emerald-200 text-emerald-800":"bg-rose-50 border-rose-200 text-rose-800"}`,children:[t.jsx("span",{className:"font-medium",children:_.status==="success"?"Import successful":"Import failed"}),t.jsx("span",{className:"truncate",children:_.message})]}),t.jsx("div",{className:"grid gap-4",children:t.jsxs("section",{className:"border rounded-xl p-3 bg-white shadow-sm","data-guide":"clients-list",children:[t.jsxs("div",{className:"flex items-center gap-1 mb-1",children:[t.jsx(w,{variant:"outline",size:"sm","data-guide":"clients-import",disabled:$||I,onClick:()=>M(),children:"Import from booking"}),t.jsx(w,{variant:"outline",size:"sm",onClick:async()=>{try{C(!0);const e=await p.post("/ai/tools/execute",{tenant_id:await d(),name:"contacts.dedupe.preview",params:{tenant_id:await d()},require_approval:!1}),s=Array.isArray(e?.groups)?e.groups:[];W(s),h(`Found ${s.length} duplicate groups`)}catch(e){h(String(e?.message||e))}finally{C(!1)}},children:"Preview duplicates"}),z.length>0&&t.jsx(w,{variant:"outline",size:"sm",onClick:async()=>{try{H(!0);const e=await p.post("/ai/tools/execute",{tenant_id:await d(),name:"contacts.dedupe",params:{tenant_id:await d()},require_approval:!0});try{o({title:"Dedupe completed",description:`${Number(e?.removed||0)} removed`})}catch{}await T(),W([])}catch(e){h(String(e?.message||e))}finally{H(!1)}},children:"Run dedupe"}),t.jsx(w,{variant:"outline",size:"sm","data-guide":"clients-export",onClick:async()=>{try{const e=await d(),s=(await ut.auth.getSession()).data.session,n=s?.access_token?{Authorization:`Bearer ${s.access_token}`}:{};let r=0;const x=1e3,v=1e4,f=[];for(;r<v;r+=x){const a=`${ht}/contacts/list?tenant_id=${encodeURIComponent(e)}&limit=${x}&offset=${r}`,S=await fetch(a,{headers:n});if(!S.ok)break;const L=await S.json().catch(()=>({})),U=Array.isArray(L?.items)?L.items:[];if(f.push(...U),U.length<x)break}const g=[["first_name","last_name","display_name","email","phone","total_revenue","total_appointments","first_visit_at","last_visit_at","tags","sms_consent","email_consent"].join(",")],i=a=>{const S=a==null?"":String(a);return/[",\n]/.test(S)?'"'+S.replace(/"/g,'""')+'"':S};f.forEach(a=>{const S=String(a?.first_name||"").trim(),L=String(a?.last_name||"").trim(),U=String(a?.display_name||"").trim(),st=String(a?.email||"").trim(),at=String(a?.phone||"").trim(),nt=Number(a?.lifetime_cents||0)/100,it=Number(a?.txn_count||0),ot=Number(a?.first_visit||0)?new Date(Number(a.first_visit)<1e12?Number(a.first_visit)*1e3:Number(a.first_visit)).toISOString():"",rt=Number(a?.last_visit||0)?new Date(Number(a.last_visit)<1e12?Number(a.last_visit)*1e3:Number(a.last_visit)).toISOString():"",ct=Array.isArray(a?.tags)?a.tags.join(","):"",lt=typeof a?.sms_consent=="boolean"?a.sms_consent?"yes":"no":"",dt=typeof a?.email_consent=="boolean"?a.email_consent?"yes":"no":"";g.push([i(S),i(L),i(U),i(st),i(at),i(nt.toFixed(2)),i(it),i(ot),i(rt),i(ct),i(lt),i(dt)].join(","))});const P=g.join(`
`),c=new Blob([P],{type:"text/csv;charset=utf-8;"}),N=document.createElement("a");N.href=URL.createObjectURL(c),N.download="contacts.csv",document.body.appendChild(N),N.click(),document.body.removeChild(N);try{o({title:"Export ready",description:"contacts.csv downloaded"})}catch{}}catch(e){h(String(e?.message||e))}},children:"Export CSV"}),t.jsx(w,{variant:"outline",size:"sm","data-guide":"clients-refresh",disabled:tt,onClick:async()=>{try{C(!0);const s=(await p.post("/onboarding/analyze",{tenant_id:await d()}))?.summary?.connected||{},n=String(s.square||"")==="connected"?"square":String(s.acuity||"")==="connected"?"acuity":"square";await p.post("/integrations/refresh",{tenant_id:await d(),provider:n}),await T();try{o({title:"Refreshed",description:n.toUpperCase()})}catch{}}catch(e){h(String(e?.message||e))}finally{C(!1)}},children:"Refresh"})]}),t.jsx("div",{className:"overflow-auto rounded-md border",style:{maxHeight:"calc(100dvh - 220px)"},children:t.jsxs("table",{className:"min-w-full text-xs",children:[t.jsx("thead",{className:"bg-slate-50 text-slate-700",children:t.jsxs("tr",{children:[t.jsx("th",{className:"text-left px-2 py-2",children:"Client"}),t.jsx("th",{className:"text-left px-2 py-2",children:"First visit"}),t.jsx("th",{className:"text-left px-2 py-2",children:"Last visit"}),t.jsx("th",{className:"text-left px-2 py-2",children:"Txns"}),t.jsx("th",{className:"text-left px-2 py-2",children:"Lifetime"}),t.jsx("th",{className:"text-left px-2 py-2",children:"Birthday"}),t.jsx("th",{className:"text-left px-2 py-2",children:"Source"})]})}),t.jsxs("tbody",{children:[q.map(e=>t.jsxs("tr",{className:"border-t",children:[t.jsx("td",{className:"px-2 py-1 font-medium text-slate-900",children:t.jsxs("div",{className:"flex items-center gap-2","data-guide":"clients-actions",children:[t.jsx("button",{className:"underline truncate max-w-[14rem]",title:F(e),onClick:()=>D({open:!0,contact:e}),children:F(e)}),t.jsx(w,{variant:"outline",size:"sm",className:"ml-1","aria-label":"Text client",onClick:async()=>{try{const s=F(e).split(" ")[0]||"there",n=Math.floor(Date.now()/1e3),r=e.last_visit?Math.max(0,Math.floor((n-Number(e.last_visit))/86400)):0,x=r>60?"It's been a while — ":r>30?"Just a quick check‑in — ":"",v=`Hi ${s}! ${x}I have a couple openings coming up and thought of you. Want me to send a few times?`;try{await navigator.clipboard.writeText(v)}catch{}try{const b=await d(),g=await p.get(`/contacts/search?tenant_id=${encodeURIComponent(b)}&q=${encodeURIComponent(e.contact_id)}&limit=1`),i=String((g?.items||[])[0]?.phone||"").trim();if(i)try{await navigator.clipboard.writeText(i),o({title:"Phone copied"})}catch{}}catch{}const f=new URLSearchParams({cid:e.contact_id,body:v});window.location.assign(`/messages?${f.toString()}`)}catch(s){h(String(s?.message||s))}},children:"Text"}),t.jsx(w,{variant:"outline",size:"sm","aria-label":"Email client",onClick:async()=>{try{let s=!1;try{const n=await d(),r=await p.get(`/contacts/search?tenant_id=${encodeURIComponent(n)}&q=${encodeURIComponent(e.contact_id)}&limit=1`),x=String((r?.items||[])[0]?.email||"").trim();x&&(await navigator.clipboard.writeText(x),s=!0)}catch{}o({title:"Email copied",description:s?void 0:"Best‑effort: address may be masked."})}catch(s){h(String(s?.message||s))}},children:"Email"})]})}),t.jsx("td",{className:"px-2 py-1",children:Z(e.first_visit)}),t.jsx("td",{className:"px-2 py-1",children:Z(e.last_visit)}),t.jsx("td",{className:"px-2 py-1",children:Number(e.txn_count||0)}),t.jsx("td",{className:"px-2 py-1",children:et(e.lifetime_cents)}),t.jsx("td",{className:"px-2 py-1",children:e.birthday||"-"}),t.jsx("td",{className:"px-2 py-1 truncate max-w-[10rem]",title:e.creation_source||"-",children:e.creation_source||"-"})]},e.contact_id)),q.length===0&&t.jsx("tr",{children:t.jsx("td",{className:"px-2 py-2",colSpan:7,children:t.jsx("div",{className:"max-w-md",children:t.jsx(yt,{title:"No clients yet",description:"Import from Booking to see clients here.",children:t.jsx(w,{variant:"outline",size:"sm",onClick:()=>O("contacts"),children:K.ctas.tertiary.guideMe})})})})})]})]})}),t.jsx("div",{"data-guide":"clients-pagination",children:t.jsx(gt,{page:E,pageSize:R,total:J||q.length,onPrev:()=>A(e=>Math.max(1,e-1)),onNext:()=>A(e=>Math.min(Math.ceil((J||q.length)/R)||1,e+1))})})]})}),$?t.jsx(ft,{className:"h-8"}):t.jsx("pre",{className:"whitespace-pre-wrap text-sm text-slate-700","data-guide":"status",children:j||"No recent actions."}),z.length>0&&t.jsxs("div",{className:"mt-2 rounded-2xl border bg-white p-3 text-sm",children:[t.jsx("div",{className:"font-medium",children:"Duplicate groups"}),t.jsx("div",{className:"text-[11px] text-slate-600 mb-1",children:"Preview only — Run dedupe to remove duplicates."}),t.jsx("div",{className:"grid gap-2 max-h-64 overflow-auto",children:z.slice(0,20).map((e,s)=>t.jsxs("div",{className:"rounded-md border bg-slate-50 p-2",children:[t.jsxs("div",{className:"text-xs font-medium text-slate-800",children:["Group ",s+1,": ",e.count," records"]}),t.jsx("ul",{className:"mt-1 text-xs list-disc ml-5",children:e.items.slice(0,5).map((n,r)=>t.jsxs("li",{children:[(n.display_name||`${n.first_name||""} ${n.last_name||""}`||"Client").trim()," · Txns ",Number(n.txn_count||0)," · LTV $",(Number(n.lifetime_cents||0)/100).toFixed(2)]},r))})]},s))})]}),I&&t.jsxs("div",{className:"fixed inset-0 z-30 grid place-items-center",children:[t.jsx("div",{"aria-hidden":!0,className:"absolute inset-0 bg-black/20"}),t.jsx("div",{className:"relative rounded-2xl border border-[var(--border)] bg-white p-4 shadow-soft text-sm",children:"Importing booking data… This usually finishes in under a minute."})]}),m&&t.jsxs("div",{className:"mt-2 rounded-2xl border bg-white p-3 text-sm",children:[t.jsx("div",{className:"font-medium",children:"Import summary"}),t.jsxs("div",{className:"text-slate-700 text-xs mt-1",children:["Provider: ",m.provider||"auto"]}),t.jsxs("div",{className:"text-slate-700 text-xs",children:["Imported: ",Number(m.imported||0),", Updated: ",Number(m.updated||0),typeof m.skipped=="number"?`, Skipped: ${m.skipped}`:""]}),m.reasonTop&&t.jsxs("div",{className:"text-slate-600 text-[11px] mt-1",children:["Top skip reason: ",m.reasonTop]}),t.jsx("div",{className:"mt-2",children:t.jsx(w,{variant:"outline",size:"sm",onClick:async()=>{try{const e=[`Provider: ${m?.provider||"auto"}`,`Imported: ${Number(m?.imported||0)}`,`Updated: ${Number(m?.updated||0)}`,typeof m?.skipped=="number"?`Skipped: ${m?.skipped}`:"",m?.reasonTop?`Top reason: ${m?.reasonTop}`:""].filter(Boolean).join(`
`);await navigator.clipboard.writeText(e),o({title:"Copied",description:"Import summary copied"})}catch{}},children:"Copy report"})})]}),B.open&&t.jsxs("div",{className:"fixed inset-0 z-40",children:[t.jsx("div",{className:"absolute inset-0 bg-black/20",onClick:()=>D({open:!1})}),t.jsxs("div",{className:"absolute right-0 top-0 h-full w-full max-w-xl bg-white shadow-2xl border-l p-4",children:[t.jsxs("div",{className:"flex items-center justify-between mb-2",children:[t.jsx("div",{className:"font-semibold text-ink-900",children:"Client Expert"}),t.jsx("button",{className:"text-slate-600 hover:text-slate-800",onClick:()=>D({open:!1}),children:"Close"})]}),t.jsxs("div",{className:"text-xs text-slate-700",children:["Selected: ",B.contact?.display_name||B.contact?.contact_id]}),t.jsx("div",{className:"mt-2 border rounded-md overflow-hidden",style:{height:"60vh"},children:t.jsx("iframe",{title:"AskVX",src:"/ask?embed=1&mode=support",className:"w-full h-full"})})]})]})]})}export{At as default};
