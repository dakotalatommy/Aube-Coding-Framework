import{u as be,e as he,r,b as f,j as e}from"./react-vendor--lxKGBiW.js";import{u as ge,g as S,a as v,t as xe}from"./index-Bk3Do8do.js";import{B as N}from"./Button-DlSz7573.js";import{s as ne}from"./guide-D27LQTJO.js";import{S as K}from"./Skeleton-Bpnt4vlv.js";import{T as we,a as ye,b as oe,c as q,d as $}from"./Table-CBXGn4MI.js";import{b as je}from"./sentry-ZUDTCraJ.js";import"./radix-Dc_FVRD7.js";import"./howler-DHXmObXC.js";import"./physics-DQSz9XbC.js";import"./analytics-BPch_qa6.js";import"./supabase-CZcX4Eou.js";import"./driver-D6Mpyj2M.js";const b=[{id:"tomorrow",label:"Tomorrow",scope:"tomorrow",template:"reminder_tomorrow",description:"Clients with visits tomorrow."},{id:"this_week",label:"This Week",scope:"this_week",template:"reminder_week",description:"Upcoming appointments later this week."},{id:"reengage_30d",label:"30 Day",scope:"reengage_30d",template:"reengage_30d",description:"Guests who have not visited in ~30 days."},{id:"winback_45d",label:"45+ Day",scope:"winback_45d",template:"winback_45d",description:"Guests away for 45+ days."}],C={reminder_tomorrow:{label:"Reminder — tomorrow",description:"Friendly confirmation for tomorrow’s appointments with an easy reply CTA.",cadenceId:"reminder"},reminder_week:{label:"Reminder — this week",description:"Check-in for clients visiting later this week. Offer to adjust the time if needed.",cadenceId:"reminder_week"},reengage_30d:{label:"Re-engage 30 day",description:"Invite warm guests back around the one-month mark with a helpful prompt.",cadenceId:"reengage_30d"},winback_45d:{label:"Win-back 45+ day",description:"Encourage long-lapsed guests with a value-forward note and scheduling help.",cadenceId:"winback_45d_plus"}};function Oe(){const P=be(),Y=he(),h=new URLSearchParams(P.search).get("demo")==="1",{toastSuccess:D,toastError:m}=ge(),[T,Z]=r.useState("actions"),[R,U]=r.useState({items:[]}),[o,ie]=r.useState(b[0].id),le=r.useMemo(()=>b.find(t=>t.id===o)||b[0],[o]),[de,ee]=r.useState(!1),[g,G]=r.useState([]),[c,B]=r.useState(b[0].template),[x,u]=r.useState("idle"),[I,z]=r.useState(""),[k,J]=r.useState(null),[te,F]=r.useState(null),[w,Q]=r.useState([]),[se,_]=r.useState(""),[i,H]=r.useState(""),[ce,L]=r.useState(""),[V,W]=r.useState(""),[ae,re]=r.useState(!1),y=r.useRef(null),j=f.useCallback(()=>{if(u("idle"),z(""),J(null),F(null),Q([]),_(""),L(""),W(""),i)try{URL.revokeObjectURL(i)}catch{}H("")},[i]),p=f.useCallback(()=>{y.current&&(window.clearTimeout(y.current),y.current=null)},[]),E=f.useCallback(async()=>{try{if(h){U({items:[]});return}const t=await S(),a=await v.get(`/cadences/queue?tenant_id=${encodeURIComponent(t)}`);U(a||{items:[]})}catch{U({items:[]})}},[h]),O=f.useCallback(async t=>{const a=b.find(n=>n.id===t)||b[0];if(h){G([]),B(a.template);return}ee(!0);try{const n=await S(),s=await v.get(`/followups/candidates?tenant_id=${encodeURIComponent(n)}&scope=${encodeURIComponent(a.scope)}`),l=Array.isArray(s?.items)?s.items:[];G(l),B(a.template)}catch(n){console.error("followups candidates failed",n),G([])}finally{ee(!1)}},[h]),A=f.useCallback(async()=>{try{const t=await S(),a=await v.get(`/followups/draft_status?tenant_id=${encodeURIComponent(t)}`);W(JSON.stringify(a||{}));const n=a?.details||{};Q(n.contact_ids.map(d=>String(d))),typeof n?.template_label=="string"&&_(n.template_label),a?.job_id&&F(String(a.job_id)),J(d=>Number(a?.todo_id??n?.todo_id??d??0)||d);const s=String(a?.status||"pending"),l=String(a?.job_status||n?.job_status||"");if(s==="ready"){p();const d=String(n?.draft_markdown||"");if(u("ready"),z(d),d){try{i&&URL.revokeObjectURL(i)}catch{}try{const M=new Blob([d],{type:"text/markdown;charset=utf-8"}),X=URL.createObjectURL(M);H(X)}catch{}}}else s==="error"||l==="error"?(p(),u("error"),L(String(n?.error||a?.detail||"Unable to generate draft"))):(u("generating"),y.current=window.setTimeout(A,3200))}catch(t){console.error("followups draft status failed",t),y.current=window.setTimeout(A,4500)}},[i,p]),me=f.useCallback(()=>{if(!I){m("No draft yet","Generate a draft before opening Messages.");return}if(!w.length){m("Missing contacts","Draft does not include any contacts to prefill.");return}try{const t={ids:w,bucket:c,scope:o,templateLabel:se,markdown:I,ts:Date.now(),jobId:te,todoId:k};sessionStorage.setItem("bvx_followups_bundle",JSON.stringify(t));const a=new URLSearchParams(P.search);a.set("pane","messages"),Y({pathname:"/workspace",search:`?${a.toString()}`})}catch(t){console.error("openInMessages failed",t),m("Unable to open Messages",String(t?.message||t||""))}},[w,I,te,se,k,P.search,Y,c,o,m]),ue=f.useCallback(async()=>{if(!h){p(),j(),u("generating");try{const t=await S(),a=b.find(l=>l.id===o)||b[0];_(C[c]?.label||a.label);const n={tenant_id:t,scope:a.scope,template_id:c},s=await v.post("/followups/draft_batch",n);if(W(JSON.stringify(s||{})),s?.status==="empty"){u("empty"),m("No clients found","Pick a different segment to draft follow-ups.");return}if(s?.status==="error"){u("error"),L(String(s?.detail||"Unable to create draft")),m("Draft failed",s?.detail||"AI was unable to create a draft. Please try again.");return}if(J(Number(s?.todo_id||0)),s?.job_id&&F(String(s.job_id)),s?.details?(Array.isArray(s.details.contact_ids)&&Q(s.details.contact_ids.map(l=>String(l))),typeof s.details.template_label=="string"&&_(s.details.template_label)):_(C[c]?.label||a.label),s?.status==="ready"&&s?.draft_markdown){p();const l=String(s?.draft_markdown||"");u("ready"),z(l);try{i&&URL.revokeObjectURL(i)}catch{}if(l)try{const d=new Blob([l],{type:"text/markdown;charset=utf-8"}),M=URL.createObjectURL(d);H(M)}catch{}D("Draft ready",`Generated ${s?.count??g.length} follow-up(s).`)}else y.current=window.setTimeout(A,1500);xe("cadences.followups.draft_batch",{segment:o,status:s?.status||"pending",count:s?.count||g.length}),je({category:"cadences",level:"info",message:"draft_batch",data:{segment:o,template:c,status:s?.status}})}catch(t){console.error("draft_batch failed",t),u("error"),L(String(t?.message||t)),m("Draft failed",String(t?.message||t))}}},[o,j,h,A,g.length,c,p,m,D]),pe=f.useCallback(async()=>{if(!(!k||h)){re(!0);try{const t=await S();await v.post("/todo/ack",{tenant_id:t,id:k});const a=C[c],n=w.length>0?w:g.map(s=>s.contact_id);if(a&&n.length>0)try{await v.post("/followups/enqueue",{tenant_id:t,contact_ids:n,cadence_id:a.cadenceId})}catch(s){console.warn("followups enqueue failed",s)}D("Draft approved","Saved to To-Do and queued the follow-ups."),j(),E(),await O(o)}catch(t){console.error("approve draft failed",t),m("Could not approve",String(t?.message||t))}finally{re(!1)}}},[o,j,w,k,h,E,O,g,c,m,D]);r.useEffect(()=>()=>{if(p(),i)try{URL.revokeObjectURL(i)}catch{}},[i]),r.useEffect(()=>{E()},[E]),r.useEffect(()=>{O(o)},[o,O]),r.useEffect(()=>{p(),j()},[o,j,p]),f.useEffect(()=>{try{new URLSearchParams(window.location.search).get("tour")==="1"&&ne("cadences")}catch{}},[]);const fe=r.useMemo(()=>Object.entries(C),[]);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Follow‑ups"}),e.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[e.jsx(N,{variant:"outline",size:"sm",onClick:()=>ne("cadences"),children:"Guide me"}),e.jsx(N,{variant:"outline",size:"sm",onClick:()=>{window.location.href="/ask"},children:"AskVX"})]})]}),e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{className:`px-3 py-1 rounded-full border text-sm ${T==="actions"?"bg-white border-pink-200 text-slate-900":"bg-white border-slate-200 text-slate-600"}`,onClick:()=>Z("actions"),children:"Actions"}),e.jsxs("button",{className:`px-3 py-1 rounded-full border text-sm ${T==="queue"?"bg-white border-pink-200 text-slate-900":"bg-white border-slate-200 text-slate-600"}`,onClick:()=>Z("queue"),children:["Queue",Array.isArray(R.items)&&R.items.length>0?` (${R.items.length})`:""]})]}),T==="actions"&&e.jsxs("section",{className:"border rounded-xl p-3 bg-white shadow-sm","aria-labelledby":"followup-builder",children:[e.jsx("div",{className:"mb-2 text-xs text-amber-700 bg-amber-50 border border-amber-100 rounded-md px-2 py-1 inline-block",children:"Drafts are saved as To‑Dos for approval before sending."}),e.jsx("div",{id:"followup-builder",className:"font-semibold mb-3",children:"Batch follow‑ups"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:"1. Choose segment"}),e.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:b.map(t=>{const a=t.id===o;return e.jsx("button",{className:`px-3 py-1.5 rounded-full border text-sm transition ${a?"bg-slate-900 text-white border-slate-900 shadow-sm":"bg-white text-slate-700 border-slate-200 hover:border-slate-300"}`,onClick:()=>ie(t.id),children:t.label},t.id)})}),e.jsxs("div",{className:"mt-2 text-xs text-slate-600",children:[le.description,de?e.jsx(K,{className:"h-4 w-28 mt-2"}):e.jsxs("span",{className:"ml-1 text-slate-500",children:["• ",g.length," client",g.length===1?"":"s"," queued"]})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:"2. Select template"}),e.jsx("select",{value:c,onChange:t=>B(t.target.value),className:"mt-2 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-400",children:fe.map(([t,a])=>e.jsx("option",{value:t,children:a.label},t))}),e.jsx("div",{className:"mt-1 text-xs text-slate-500",children:C[c]?.description})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:"3. Draft messages"}),e.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-2",children:[e.jsx(N,{variant:"primary",size:"sm",disabled:g.length===0||x==="generating",onClick:ue,children:x==="generating"?"Drafting…":"Draft follow-ups"}),e.jsx("span",{className:"text-xs text-slate-500",children:"Creates a single strategy document for review."})]})]}),x==="generating"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{className:"h-4"}),e.jsx(K,{className:"h-32"})]}),x==="ready"&&e.jsxs("div",{className:"border rounded-lg bg-slate-50 p-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold text-slate-900",children:"Preview"}),e.jsxs("div",{className:"flex items-center gap-2",children:[i&&e.jsx("a",{href:i,download:`followups_${o}_${new Date().toISOString().slice(0,10)}.md`,className:"text-xs text-slate-600 underline",children:"Download Markdown"}),e.jsx(N,{size:"sm",variant:"outline",onClick:me,children:"Open in Messages"}),e.jsx(N,{size:"sm",variant:"outline",disabled:ae,onClick:pe,children:ae?"Saving…":"Approve & queue"})]})]}),e.jsx("textarea",{readOnly:!0,value:I,className:"mt-2 h-56 w-full rounded-md border border-slate-200 bg-white px-3 py-2 text-sm font-mono text-slate-700"})]}),x==="error"&&e.jsx("div",{className:"rounded-md border border-rose-200 bg-rose-50 px-3 py-2 text-xs text-rose-700",children:ce||"Unable to generate follow-ups right now."}),x==="empty"&&e.jsx("div",{className:"rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-xs text-amber-800",children:"No clients matched this segment. Try a different range."}),V&&e.jsx("pre",{className:"text-xs text-slate-500 whitespace-pre-wrap break-words",children:V})]})]}),T==="queue"&&e.jsxs("section",{className:"border rounded-xl p-3 bg-white shadow-sm","aria-labelledby":"cadence-queue",children:[e.jsx("div",{id:"cadence-queue",className:"font-semibold mb-2",children:"Follow‑up queue"}),e.jsxs(we,{children:[e.jsx(ye,{children:e.jsxs(oe,{children:[e.jsx(q,{children:"Done"}),e.jsx(q,{children:"Contact"}),e.jsx(q,{children:"Type"}),e.jsx(q,{children:"Next Action"})]})}),e.jsx("tbody",{className:"divide-y",children:(R.items||[]).map((t,a)=>{const n=String(t.friendly_name||t.display_name||"").trim(),s=String(t.contact_id||"").trim(),l=n||s||"Client";return e.jsxs(oe,{children:[e.jsx($,{children:e.jsx("input",{type:"checkbox","aria-label":"Mark done",onChange:()=>U(d=>({items:(d.items||[]).filter((M,X)=>X!==a)}))})}),e.jsx($,{children:l}),e.jsx($,{children:t.cadence_id||"reminder"}),e.jsx($,{children:t.next_action_at})]},a)})})]})]})]}),e.jsx("pre",{className:"whitespace-pre-wrap text-sm text-slate-700",children:V||"No recent actions."})]})}export{Oe as default};
